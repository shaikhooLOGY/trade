name: E2E Test Suite

on:
  push:
    branches: [ main, develop, production-readiness-* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: "0 2 * * *"  # 2 AM UTC nightly

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['8.2', '8.3']
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP ${{ matrix.php-version }}
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, json, zip
        tools: composer:v2
        
    - name: Install Composer dependencies
      run: |
        if [ -f composer.json ]; then
          composer install --no-progress --prefer-dist --optimize-autoloader
        else
          echo "No composer.json found, skipping composer install"
        fi
      continue-on-error: true
      
    - name: Start PHP built-in server
      run: |
        php -S 127.0.0.1:8082 -t . &
        echo "SERVER_PID=$!" >> $GITHUB_ENV
        
    - name: Wait for server to be ready
      run: |
        for i in {1..10}; do
          if curl -s http://127.0.0.1:8082 >/dev/null 2>&1; then
            echo "Server is ready"
            break
          fi
          echo "Waiting for server... ($i/10)"
          sleep 2
        done
        
    - name: Set environment variables
      run: |
        export APP_ENV=ci
        export APP_FEATURE_APIS=on
        export BASE_URL=http://127.0.0.1:8082
        export ALLOW_CSRF_BYPASS=1
        echo "APP_ENV=ci" >> $GITHUB_ENV
        echo "APP_FEATURE_APIS=on" >> $GITHUB_ENV
        echo "BASE_URL=http://127.0.0.1:8082" >> $GITHUB_ENV
        echo "ALLOW_CSRF_BYPASS=1" >> $GITHUB_ENV
        
    - name: Run E2E Test Suite
      run: |
        chmod +x maintenance/run_e2e.sh
        bash maintenance/run_e2e.sh --cleanup=on || true
      env:
        APP_ENV: ci
        APP_FEATURE_APIS: on
        BASE_URL: http://127.0.0.1:8082
        ALLOW_CSRF_BYPASS: 1

    - name: Run Self-Healing (if failed)
      if: failure()
      run: |
        # Create healing log directory
        mkdir -p reports/e2e/heal_logs
        
        # Run healing script
        if [ -f "maintenance/e2e_heal.sh" ]; then
          chmod +x maintenance/e2e_heal.sh
          echo "Running self-healing script..."
          bash maintenance/e2e_heal.sh || echo "Healing failed, continuing..."
        else
          echo "Healing script not found, skipping self-healing"
        fi
        
        # Log healing attempt
        echo "Healing attempt: $(date -u +%Y-%m-%dT%H:%M:%SZ)" > reports/e2e/heal_logs/last_attempt.log
        
    - name: Create GitHub Issue (on failure)
      if: failure() && github.event_name == 'schedule'
      uses: actions/github-script@v7
      with:
        script: |
          const title = `E2E Failing Tests [${new Date().toISOString().split('T')[0]}]`;
          const body = `
          **E2E Test Suite Failure Report**
          
          **Date:** ${new Date().toISOString()}
          **Run ID:** ${context.runId}
          **Commit:** ${context.sha}
          **Branch:** ${context.ref}
          
          **Status:** ğŸ”´ FAILED
          
          **Artifacts:**
          - E2E Reports: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
          - Workflow: ${context.payload.repository.html_url}/actions/runs/${context.runId}
          
          **Next Steps:**
          1. Review the failure logs
          2. Check if healing script resolved the issue
          3. Re-run tests after fixes
          4. Monitor nightly runs for patterns
          
          *This issue was automatically created by the E2E Self-Healing CI system.*
          `;
          
          try {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['e2e', 'ci-failure', 'auto-generated']
            });
            console.log('Issue created successfully');
          } catch (error) {
            console.log('Failed to create issue:', error);
          }
        
    - name: Write CI status
      run: |
        STATUS="passed"
        PASS_RATE=0
        if [ -f "reports/e2e/last_status.json" ]; then
          PASS_RATE=$(jq -r '.pass_rate' reports/e2e/last_status.json)
          if [ "$PASS_RATE" = "0" ] || [ -z "$PASS_RATE" ]; then
            STATUS="failed"
            PASS_RATE=0
          else
            STATUS="passed"
          fi
        else
          STATUS="failed"
          PASS_RATE=0
        fi
        
        cat > reports/e2e/ci_status.json << EOF
        {
          "sha": "${{ github.sha }}",
          "status": "$STATUS",
          "pass_rate": $PASS_RATE,
          "run_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "artifacts_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
          "provider": "github",
          "php_version": "${{ matrix.php-version }}"
        }
        EOF
        
    - name: Upload E2E artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-reports-php${{ matrix.php-version }}
        path: |
          reports/e2e/
          context/project_context.json
          logs/
        retention-days: 30
        
    - name: Upload OpenAPI docs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: openapi-docs-php${{ matrix.php-version }}
        path: docs/openapi.yaml
        retention-days: 30
        
    - name: Check E2E status
      run: |
        if [ -f "reports/e2e/ci_status.json" ]; then
          echo "E2E CI Status:"
          cat reports/e2e/ci_status.json
        else
          echo "No CI status file found"
          exit 1
        fi
        
    - name: Stop PHP server
      if: always()
      run: |
        if [ ! -z "$SERVER_PID" ]; then
          kill $SERVER_PID || true
        fi