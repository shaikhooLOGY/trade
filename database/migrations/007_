-- Migration 007: Audit Trail Schema Alignment
-- Authoritative Audit Events Table Implementation
-- Created: 2025-11-06
-- Description: Creates/updates audit_events table to match authoritative schema

-- Migration check: Only apply if needed
-- This migration is guarded to handle both new installations and existing installations safely

-- Step 1: Check if audit_events table exists and create/update accordingly
CREATE TABLE IF NOT EXISTS audit_events (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    actor_id BIGINT NOT NULL,
    action VARCHAR(100) NOT NULL,
    entity VARCHAR(50) NOT NULL,
    entity_id BIGINT NULL,
    summary TEXT NULL,
    ip_address VARCHAR(45) NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_actor_id (actor_id),
    INDEX idx_action (action),
    INDEX idx_entity (entity),
    INDEX idx_created_at (created_at),
    INDEX idx_actor_action (actor_id, action),
    INDEX idx_entity_type (entity, entity_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT="Authoritative audit events table";

-- Step 2: If table exists but missing columns, add them (non-destructive)
SET @sql = CONCAT('ALTER TABLE audit_events ',
    'ADD COLUMN IF NOT EXISTS actor_id BIGINT NOT NULL AFTER id, ',
    'ADD COLUMN IF NOT EXISTS action VARCHAR(100) NOT NULL AFTER actor_id, ',
    'ADD COLUMN IF NOT EXISTS entity VARCHAR(50) NOT NULL AFTER action, ',
    'ADD COLUMN IF NOT EXISTS entity_id BIGINT NULL AFTER entity, ',
    'ADD COLUMN IF NOT EXISTS summary TEXT NULL AFTER entity_id, ',
    'ADD COLUMN IF NOT EXISTS ip_address VARCHAR(45) NULL AFTER summary'
);

PREPARE alter_stmt FROM @sql;
EXECUTE alter_stmt;
DEALLOCATE PREPARE alter_stmt;

-- Step 3: Create indexes if they don't exist (for performance)
CREATE INDEX IF NOT EXISTS idx_actor_id ON audit_events (actor_id);
CREATE INDEX IF NOT EXISTS idx_action ON audit_events (action);
CREATE INDEX IF NOT EXISTS idx_entity ON audit_events (entity);
CREATE INDEX IF NOT EXISTS idx_created_at ON audit_events (created_at);
CREATE INDEX IF NOT EXISTS idx_actor_action ON audit_events (actor_id, action);
CREATE INDEX IF NOT EXISTS idx_entity_type ON audit_events (entity, entity_id);

-- Migration completed successfully
SELECT 'Migration 007: Audit trail schema alignment completed successfully' as result;